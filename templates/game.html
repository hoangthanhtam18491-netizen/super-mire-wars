<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机甲战棋游戏</title>

    <!-- [MODIFIED] 导入 Firebase SDK -->
    <!-- [FIX #8] 在导入 SDK 之前注入配置变量 -->
    <script>
        // 这些将由 Jinja 填充
        // [MODIFIED] firebase_config 现在是一个字典, tojson 会正确地将其序列化为 JSON 对象字面量
        window.firebaseConfig = {{ firebase_config | tojson | safe }};
        window.__app_id = {{ app_id | tojson | safe }};
        window.__initial_auth_token = {{ initial_auth_token | tojson | safe }};
    </script>

    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg-color: #1a202c; --border-color: #4a5568; --text-color: #e2e8f0; --primary-color: #4299e1;
            --hover-bg-color: #2c3748; --disabled-color: #718096; --player-color: #3182ce; --ai-color: #c53030;
            --highlight-move: rgba(66, 153, 225, 0.3); --highlight-attack: rgba(197, 48, 48, 0.4); --phase-color: #f6ad55;
            --highlight-launch: rgba(237, 137, 54, 0.4); /* [v1.21] 新增：抛射高亮 */
            --status-ok: #2ecc71; --status-damaged: #f39c12; --status-destroyed: #e74c3c;
            /* [v1.22 修复] 使用 CSS 变量设置棋盘尺寸 */
            --cell-size: 50px;
            --grid-width: {{ game.board_width }};
            --grid-height: {{ game.board_height }};
        }
        body { font-family: sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: flex-start; padding: 2rem; gap: 2rem; }
        .panel { background-color: var(--hover-bg-color); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1.5rem; }
        .sidebar { width: 320px; display: flex; flex-direction: column; gap: 1.5rem; }
        .game-board {
            display: grid;
            /* [v1.22 修复] 使用 CSS 变量 */
            grid-template-columns: repeat(var(--grid-width), var(--cell-size));
            grid-template-rows: repeat(var(--grid-height), var(--cell-size));
            border: 2px solid var(--border-color);
            gap: 1px;
            background-color: var(--border-color);
            position: relative; /* [v1.22] 确保绝对定位的图标以此为锚点 */

            /* [图标更新] 添加背景图片 */
            background-image: url('static/images/maps/basic.jpg');
            background-size: cover; /* 覆盖整个棋盘 */
            background-position: center center;
        }
        .grid-cell {
            width: var(--cell-size);
            height: var(--cell-size);
            /* [图标更新] 修改背景为半透明 */
            background-color: rgba(26, 32, 44, 0.8); /* var(--bg-color) 80% 透明度 */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .grid-cell.highlight-move, .grid-cell.highlight-attack, .grid-cell.highlight-launch { cursor: pointer; }
        .grid-cell.highlight-move { background-color: var(--highlight-move); }
        .grid-cell.highlight-attack { background-color: var(--highlight-attack); }
        .grid-cell.highlight-launch { background-color: var(--highlight-launch); } /* [v1.21] 新增 */

        .mech-icon-wrapper {
            position: absolute; /* [v1.22] 恢复绝对定位 */
            width: var(--cell-size);
            height: var(--cell-size);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            transition: transform 0.4s ease-out, left 0.4s ease-out, top 0.4s ease-out; /* [v1.22] 增加 left/top 过渡 */
            pointer-events: none; /* [v1.22] 图标本身不应捕获点击 */
        }
        .mech-icon {
            /* [图标更新] 修改 font-size 为 width/height */
            width: 36px;
            height: 36px;
            position: relative;
            filter: drop-shadow(0 0 5px);
        }

        /* [图标更新] 移除 SVG 样式 */

        /* [图标更新]
           为 <img> 添加样式
        */
        .mech-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* 改为 contain 以免图片变形 */
            border-radius: 4px; /* (可选) 给图标加个小圆角 */
            transition: transform 0.3s ease; /* [朝向] 添加翻转动画 */
        }

        /* 现有的 .player/.ai/.neutral 规则在这里，但对 <img> 作用不大 */
        .mech-icon.player { color: var(--player-color); }
        .mech-icon.ai { color: var(--ai-color); }
        .mech-icon.neutral { color: var(--disabled-color); } /* [v1.22] 新增 (用于抛射物) */

        .orientation-arrow { position: absolute; font-size: 14px; color: white; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .orientation-selector { position: absolute; z-index: 10; display: none; flex-direction: column; background-color: rgba(0,0,0,0.8); border-radius: 50%; }
        /* [MODIFIED] 为方向按钮添加 ID */
        .orientation-button { background: none; border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; }

        @keyframes damage-popup {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-40px); opacity: 0; }
        }
        .damage-indicator {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            color: white;
            z-index: 10;
            animation: damage-popup 1.2s ease-out forwards; /* [MODIFIED] 动画时长 1.2s */
            pointer-events: none;
        }
        .damage-indicator.hit {
            background-color: rgba(197, 48, 48, 0.9);
        }
        .damage-indicator.miss {
            background-color: rgba(113, 128, 150, 0.9);
        }

        /* [新增] 爆炸动画 */
        @keyframes explosion-animation {
            0% {
                transform: scale(0);
                opacity: 1;
                border: 2px solid rgba(246, 173, 85, 1); /* var(--phase-color) */
            }
            50% {
                opacity: 0.8;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
                border: 2px solid rgba(246, 173, 85, 0);
            }
        }
        .explosion-effect {
            position: absolute;
            width: var(--cell-size);
            height: var(--cell-size);
            border-radius: 50%;
            background-color: rgba(246, 173, 85, 0.3); /* var(--phase-color) with alpha */
            animation: explosion-animation 0.8s ease-out forwards; /* [修改] 延长爆炸动画 */
            z-index: 15;
            pointer-events: none;
        }
        /* [爆炸动画结束] */


        #dice-roll-modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 199;
            justify-content: center;
            align-items: center;
        }
        #dice-roll-modal {
            background-color: var(--hover-bg-color);
            border: 2px solid var(--primary-color);
            border-radius: 0.5rem;
            padding: 1.5rem 2rem;
            z-index: 200;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #dice-roll-modal h3 {
            margin-top: 0;
            text-align: center;
            color: var(--phase-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        .dice-roll-section {
            margin-bottom: 1.5rem;
        }
        .dice-roll-section h4 {
            font-size: 1.1rem;
            color: var(--text-color);
            margin-bottom: 0.75rem;
            border-bottom: 1px dashed var(--border-color);
        }
        .dice-roll-section .dice-group {
            min-height: 2.5rem;
            background-color: var(--bg-color);
            border-radius: 0.25rem;
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        .dice-roll-section span {
            font-size: 0.9rem;
            color: var(--disabled-color);
            margin-right: 0.5rem;
        }
        .dice-icon {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            line-height: 1.5rem;
            border-radius: 0.25rem;
            text-align: center;
            font-weight: bold;
            font-size: 0.85rem;
            margin: 0.1rem;
        }
        /* 骰子颜色 */
        :root {
            --dice-yellow: #f6e05e; --dice-red: #f56565; --dice-white: #e2e8f0; --dice-blue: #63b3ed;
        }
        .dice-input.yellow { background-color: var(--dice-yellow); color: #1a202c; }
        .dice-input.red { background-color: var(--dice-red); color: white; }
        .dice-input.white { background-color: var(--dice-white); color: #1a202c; }
        .dice-input.blue { background-color: var(--dice-blue); color: white; }
        .dice-result.重击 { background-color: var(--dice-red); color: white; }
        .dice-result.轻击 { background-color: var(--dice-yellow); color: #1a202c; }
        .dice-result.防御 { background-color: var(--dice-white); color: #1a202c; }
        .dice-result.闪避 { background-color: var(--dice-blue); color: white; }
        .dice-result.空心重击, .dice-result.空心轻击, .dice-result.空心防御 {
            background-color: transparent; border: 2px solid var(--border-color); color: var(--text-color); opacity: 0.7;
        }
        .dice-result.闪电 { background-color: #f6ad55; color: #1a202c; }
        .dice-result.眼睛 { background-color: #9f7aea; color: white; }
        .dice-result.空白 { background-color: #2d3748; color: var(--disabled-color); }

        /* [v_REROLL] 新增重投样式 */
        .dice-reroll-group {
            display: inline-flex; /* [v_REROLL_FIX] 改为 inline-flex */
            align-items: center;
            justify-content: center;
            padding: 2px;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: all 0.2s;
            /* 确保组合骰子（如 轻击*2）靠在一起 */
            gap: 0.1rem;
        }
        .dice-reroll-group.clickable {
            cursor: pointer;
        }
        .dice-reroll-group.clickable:hover {
            transform: scale(1.1);
            background-color: rgba(66, 153, 225, 0.2);
            border-color: var(--primary-color);
        }
        .dice-reroll-group.selected {
            box-shadow: 0 0 10px 3px var(--primary-color);
            border-color: var(--primary-color);
            background-color: #2c3748;
        }
        .dice-reroll-group.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .reroll-hidden {
            display: none !important;
        }


        table { width: 100%; border-collapse: collapse; } th, td { text-align: left; padding: 0.5rem; border-bottom: 1px solid var(--border-color); }
        h4 { margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; }
        /* [MODIFIED] 移除 .action-item:hover, JS 将处理 'disabled' 类 */
        .action-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.25rem; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s; }
        .action-item.disabled, button.disabled { background-color: var(--bg-color) !important; color: var(--disabled-color) !important; cursor: not-allowed !important; border-color: var(--disabled-color) !important; }
        .action-cost { font-weight: bold; color: var(--primary-color); }
        .btn { width: 100%; padding: 0.75rem; border: none; border-radius: 0.25rem; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .selector-group button { flex: 1; padding: 0.5rem; background-color: transparent; border: 1px solid var(--border-color); color: var(--text-color); cursor: pointer; }
        .selector-group button.active { background-color: var(--primary-color); border-color: var(--primary-color); }
        .combat-log { background-color: var(--bg-color); padding: 1rem; border-radius: 0.25rem; height: 200px; overflow-y: auto; }
        .phase-indicator { text-align: center; font-size: 1.2rem; font-weight: bold; color: var(--phase-color); padding: 0.5rem; border: 1px solid var(--phase-color); border-radius: 0.5rem; margin-bottom: 1rem; }
        #part-selector-modal, #game-over-modal, #effect-selector-modal {
            display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: var(--hover-bg-color); border: 2px solid var(--primary-color);
            border-radius: 0.5rem; padding: 2rem; z-index: 100; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #effect-buttons .btn { margin-bottom: 0.5rem; background-color: var(--primary-color); }
        #effect-buttons .btn:hover { background-color: #2b6cb0; }
        #effect-buttons .btn strong { font-size: 1.1rem; }
        #effect-buttons .btn small { font-size: 0.85rem; color: var(--text-color); opacity: 0.9; }

        .status-ok { color: var(--status-ok); } .status-damaged { color: var(--status-damaged); } .status-destroyed { color: var(--status-destroyed); text-decoration: line-through; }

        /* [新增] 部件详情弹窗样式 */
        #part-detail-modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 199;
            justify-content: center;
            align-items: center;
        }
        #part-detail-modal {
            background-color: var(--hover-bg-color);
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            z-index: 200;
            width: 90%;
            max-width: 320px; /* 宽度与侧边栏一致 */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        #part-detail-close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        #part-detail-title {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        #part-detail-image-container {
            width: 100%;
            margin-bottom: 1rem;
        }
        #part-detail-image {
            width: 100%;
            height: auto;
            border-radius: 0.25rem;
            background-color: var(--bg-color);
        }
        #part-detail-stats-container {
            background-color: var(--bg-color);
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }
        #part-detail-stats-container ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #part-detail-actions-list {
            max-height: 150px;
            overflow-y: auto;
        }
        .part-detail-action {
            background-color: var(--bg-color);
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .part-detail-action strong {
            color: var(--text-color);
        }
        .part-detail-action small {
            display: block;
            color: var(--disabled-color);
            font-size: 0.8rem;
        }

        /* [新增] 标签页按钮样式 */
        .tab-buttons {
            display: flex;
            margin-top: 1rem;
            border-bottom: 2px solid var(--border-color);
            /* [修改] 移除 gap，让按钮靠在一起 */
        }
        .tab-button {
            flex: 1;
            padding: 0.75rem 0.5rem;
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--disabled-color);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: -2px; /* 让激活的边框覆盖父元素的边框 */
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-button:hover:not(.active) {
            color: var(--text-color);
            background-color: var(--bg-color);
        }
        /* [新增] 标签页内容面板样式 */
        .tab-panel {
            padding-top: 1.5rem; /* 在标签页和内容之间添加一些间距 */
            /* [修改] 移除 gap，因为 gap 是在 .sidebar 上设置的 */
        }

        /* [新增] 动作列表滚动条 */
        #main-action-list-wrapper {
            /* [MODIFIED] 调整高度以适应约4个项目 */
            max-height: 12rem; /* <--- 这就是修改的地方 */
            overflow-y: auto;  /* 如果内容超出，显示垂直滚动条 */
            padding-right: 0.5rem; /* 为滚动条腾出一点空间 */
            margin-right: -0.5rem; /* 抵消 padding */
        }
        /* [新增] 自定义滚动条样式 (美观) */
        #main-action-list-wrapper::-webkit-scrollbar {
            width: 8px;
        }
        #main-action-list-wrapper::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
        }
        #main-action-list-wrapper::-webkit-scrollbar-track {
            background-color: var(--bg-color);
        }

    </style>
</head>
<body>
    <!--
    [v1.17]
    使用 Jinja 变量 player_mech 和 ai_mech
    这些变量由 app.py 在 render_template 时传入
    -->
    {% set player_mech = game.get_player_mech() %}
    {% set ai_mech = game.get_ai_mech() %}

    <!-- [顶部栏] -->
    <!-- [MODIFIED] 侧边栏结构调整 -->
    <div class="sidebar panel">

        <!-- === 1. 顶部固定区 (始终可见) === -->
        <h4>玩家机甲</h4>
        {% if game_mode == 'horde' %}
        <div style="text-align: center; font-size: 1.5rem; color: var(--phase-color);">
            击败数: <span id="defeat-count">{{ ai_defeat_count }}</span>
        </div>
        {% endif %}

        {% if player_mech %}

            <!-- [新规则：宕机显示] -->
            {% if player_mech.stance == 'downed' %}
            <div class="phase-indicator" style="color: var(--status-destroyed); border-color: var(--status-destroyed); background-color: #4a2121;">
                系统宕机！
            </div>
            {% else %}
            <div class="phase-indicator">阶段: {{ {'timing': '1. 选择时机', 'stance': '2. 选择姿态', 'adjustment': '3. 调整阶段', 'main': '4. 执行动作'}[player_mech.turn_phase] }}</div>
            {% endif %}
            <!-- [修改结束] -->

            {% if player_mech.pending_effect_data %}
            <div id="pending-effect-warning" style="padding: 1rem; background-color: #c53030; color: white; border-radius: 0.25rem; text-align: center; font-weight: bold;">
                待处理：请选择效果
            </div>
            {% endif %}
            <!-- [v_REROLL] 新增重投警告 -->
            {% if player_mech.pending_reroll_data %}
            <div id="pending-reroll-warning" style="padding: 1rem; background-color: #c53030; color: white; border-radius: 0.25rem; text-align: center; font-weight: bold;">
                待处理：请解决重投
            </div>
            {% endif %}


            <!-- [MODIFIED v2.2] 驾驶员信息 -->
            <div id="player-pilot-info" class="bg-gray-900 p-3 rounded-lg border border-blue-500">
                {% if player_pilot %}
                    <h5 class="font-bold text-lg text-blue-300">{{ player_pilot.name }}</h5>
                    <p class="text-sm">链接值: <span class="font-bold text-white">{{ player_pilot.link_points }}</span></p>
                    <div class="text-xs grid grid-cols-2 gap-x-2 mt-1 text-gray-400">
                        {% for stat_name, value in player_pilot.speed_stats.items() %}
                        <span>{{ stat_name }}: {{ value }}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    <h5 class="font-bold text-lg text-gray-500">无驾驶员</h5>
                {% endif %}
            </div>

            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div><div style="font-size: 0.875rem; color: var(--disabled-color);">行动时点 (AP)</div><div style="font-size: 1.75rem; font-weight: bold;">{{ player_mech.player_ap }}</div></div>
                <div><div style="font-size: 0.875rem; color: var(--disabled-color);">调整时点 (TP)</div><div style="font-size: 1.75rem; font-weight: bold;">{{ player_mech.player_tp }}</div></div>
            </div>

        <!-- === 2. 标签页按钮区 (新) === -->
        <div class="tab-buttons">
            <button id="tab-btn-actions" class="tab-button active">
                动作
            </button>
            <button id="tab-btn-status" class="tab-button">
                状态
            </button>
        </div>

        <!-- === 3. 标签页内容区 (新) === -->

        <!-- 动作面板 (默认显示) -->
        <div id="tab-panel-actions" class="tab-panel">
            <!-- [MODIFIED] 将所有 phase-controls 移到这里 -->
            <div id="phase-timing-controls"><h4>选择时机</h4><div class="selector-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;"><button id="timing-近战">近战</button><button id="timing-射击">射击</button><button id="timing-移动">移动</button><button id="timing-抛射">抛射</button><button id="timing-快速" style="grid-column: span 2;">快速</button></div><button class="btn" id="confirm-timing-btn" style="margin-top: 1rem; background-color: var(--primary-color);">确认时机</button></div>
            <div id="phase-stance-controls"><h4>姿态选择</h4><div class="selector-group" style="display: flex;"><button id="stance-defense" class="{{ 'active' if player_mech.stance == 'defense' else '' }}">防御</button><button id="stance-agile" class="{{ 'active' if player_mech.stance == 'agile' else '' }}">机动</button><button id="stance-attack" class="{{ 'active' if player_mech.stance == 'attack' else '' }}">攻击</button></div><button class="btn" id="confirm-stance-btn" style="margin-top: 1rem; background-color: var(--primary-color);">确认姿态</button></div>
            <div id="phase-adjustment-controls"><h4>调整时点动作 (TP)</h4><div id="action-adjust-move" class="action-item"><span>调整移动</span><span class="action-cost">1 TP</span></div><div id="action-change-orientation" class="action-item"><span>仅转向</span><span class="action-cost">1 TP</span></div><button class="btn" id="skip-adjustment-btn" style="margin-top: 1rem;">跳过调整</button></div>

            <!-- [MODIFIED] 主动作面板 -->
            <div id="phase-main-controls">
                <h4>行动时点动作 (AP)</h4>

                <!-- [NEW] 新增的包裹容器，用于实现滚动条 -->
                <div id="main-action-list-wrapper">

                    {% for action, part_slot in player_mech.get_all_actions() %}
                    {% if action.action_type != '被动' %}
                    {% set action_id = (part_slot, action.name) %}
                    <!-- [BUG 修复] JSON 序列化/反序列化会将 tuple 变为 list。
                         Jinja 在比较时需要匹配类型，所以我们将 (str, str) 元组转换为 [str, str] 列表。 -->
                    {% set action_id_list = [part_slot, action.name] %}
                    {% set is_used = action_id_list in player_actions_used %}
                    {% set ammo_key = (player_mech.id, part_slot, action.name) %}
                    {% set current_ammo = game.ammo_counts.get(ammo_key, 0) %}
                    {% set out_of_ammo = (action.ammo > 0 and current_ammo <= 0) %}
                    <!-- [MODIFIED] 弃置动作的特殊处理 -->
                    {% set is_jettison = action.name == '【弃置】' %}
                    <!-- [MODIFIED] 移除 onclick, 添加 data-* 属性 -->
                    <div class="action-item {{ 'disabled' if is_used or out_of_ammo else '' }}"
                         id="action-{{ action.name }}-{{ part_slot }}"
                         data-action-name="{{ action.name }}"
                         data-action-range="{{ action.range_val }}"
                         data-action-type="{{ action.action_type }}"
                         data-action-cost="{{ action.cost }}"
                         data-part-slot="{{ part_slot }}"
                         data-is-jettison="{{ 'true' if is_jettison else 'false' }}"
                         title="{{ '本回合已使用' if is_used else ('弹药耗尽' if out_of_ammo else '') }}">
                        <span>
                            {{ action.name }} ({{ part_slot }})
                            {% if action.ammo > 0 %}
                                <span style="color: var(--phase-color); font-size: 0.8rem;"> [{{ current_ammo }}/{{ action.ammo }}]</span>
                            {% endif %}
                        </span>
                        {% if action.cost == 'L' %}
                            <span class="action-cost">2 AP + 1 TP</span>
                        {% else %}
                            <span class="action-cost">{{ action.cost.count('M')*2 + action.cost.count('S')*1 }} AP</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}

                </div>
                <!-- [NEW] 包裹容器结束 -->

            </div>
            <!-- [MODIFIED] 主动作面板结束 -->

        </div>

        <!-- 状态面板 (默认隐藏) -->
        <div id="tab-panel-status" class="tab-panel" style="display: none;">
            <!-- [MODIFIED] 将 <table> 移到这里 -->
            <table><thead><tr><th>槽位</th><th>名称</th><th>状态</th></tr></thead>
                <tbody>
                    {% for slot, part in player_mech.parts.items() %}
                    <!-- [MODIFIED] 移除 onclick, 添加 data-* 属性 -->
                    <tr style="cursor: pointer;" data-controller="player" data-part-slot="{{ slot }}">
                        <td>{{ slot }}</td>
                        <td>{{ part.name if part else 'N/A' }}</td>
                        <td class="status-{{ part.status if part else 'destroyed' }}">{{ part.status if part else 'destroyed' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% else %}
        <!-- 如果玩家机甲未加载 -->
        <div class="phase-indicator" style="color: var(--status-destroyed);">玩家机甲未加载</div>
        {% endif %}

        <!-- === 4. 结束回合按钮 (始终可见) === -->
        <!-- [MODIFIED] 移除 onclick -->
        <form id="end-turn-form" action="{{ url_for('game.end_turn') }}" method="POST" style="display: none;"><button type="submit"></button></form>
        <button id="end-turn-btn" class="btn" style="background-color: #c53030;">结束回合</button>
    </div>

    <!-- [棋盘] -->
    <div class="game-board" id="game-board"
         style="--grid-width: {{ game.board_width }}; --grid-height: {{ game.board_height }};">
        <!-- 棋盘格 -->
        {% for y in range(1, game.board_height + 1) %}
            {% for x in range(1, game.board_width + 1) %}
                <div class="grid-cell" id="cell-{{x}}-{{y}}" data-x="{{x}}" data-y="{{y}}"></div>
            {% endfor %}
        {% endfor %}

        <!--
        [v1.25 修复]
        恢复 v1.22 的绝对定位逻辑。
        Jinja 在服务器端渲染所有实体，JS 在客户端将其定位。
        -->
        {% for entity in game.get_all_renderable_entities() %}
        <div class="mech-icon-wrapper" id="entity-{{ entity.id }}-wrapper"
             data-last-pos="{{ entity.last_pos | tojson | safe }}"
             data-current-pos="{{ entity.pos | tojson | safe }}"
             style="position: absolute; left: -9999px; top: -9999px; /* JS会设置正确位置 */">

            <!-- [图标更新] 替换 SVG 为 <img> 标签，使用占位符 URL -->
            <div class="mech-icon {{ entity.controller_css }}">

                <!-- 你可以在这里替换为你自己的图片 URL -->
                {% set icon_url = 'https://placehold.co/64x64/718096/E2E8F0?text=?' %} <!-- 默认图标 -->

                {% if entity.entity_type == 'mech' %}
                    {% if entity.controller == 'player' %}
                        <!-- 玩家机甲图标 -->
                        {% set icon_url = 'static/images/icon/player2.png' %}
                    {% else %}
                        <!-- AI 机甲图标 -->
                        {% set icon_url = 'static/images/icon/AI2.png' %}
                    {% endif %}

                <!-- [MODIFIED] 抛射物图标 -->
                {% elif entity.entity_type == 'projectile' %}
                    {% if entity.name == 'MC-3 “利剑”导弹' %}
                        {% set icon_url = 'static/images/icon/rocket.jpg' %}
                    {% elif entity.name == 'RA-81火箭弹' %}
                        {% set icon_url = 'static/images/icon/rocket.jpg' %}
                    {% else %}
                        {% set icon_url = 'https://placehold.co/64x64/A0AEC0/FFFFFF?text=PROJ' %}
                    {% endif %}

                {% elif entity.entity_type == 'drone' %}
                    <!-- 无人机图标 -->
                    {% set icon_url = 'https://placehold.co/64x64/9F7AEA/FFFFFF?text=DRONE' %}
                {% endif %}

                <!-- [朝向] 添加 id="img-{{ entity.id }}" -->
                <img src="{{ icon_url }}" alt="{{ entity.entity_type }}"
                     id="img-{{ entity.id }}"
                     style="width: 100%; height: 100%; object-fit: contain;"
                     onerror="this.onerror=null; this.src='https://placehold.co/64x64/718096/E2E8F0?text=?';">

                <span class="orientation-arrow" id="arrow-{{ entity.id }}">{{ orientationMap[entity.orientation] }}</span>
            </div>
        </div>
        {% endfor %}

        <!-- [MODIFIED] 为方向按钮添加 ID -->
        <div id="orientation-selector" class="orientation-selector">
            <button class="orientation-button" id="orientation-N">⬆</button>
            <button class="orientation-button" id="orientation-E">➡</button>
            <button class="orientation-button" id="orientation-S">⬇</button>
            <button class="orientation-button" id="orientation-W">⬅</button>
        </div>
    </div>

    <!-- [右侧栏] -->
    <div class="sidebar panel">
        <h4>AI机甲状态</h4>

        <!-- [MODIFIED v2.2] AI 驾驶员信息 -->
        <div id="ai-pilot-info" class="bg-gray-900 p-3 rounded-lg border border-red-500 mb-4">
            {% if ai_pilot %}
                <h5 class="font-bold text-lg text-red-300">{{ ai_pilot.name }}</h5>
                <p class="text-sm">链接值: <span class="font-bold text-white">{{ ai_pilot.link_points }}</span></p>
                <div class="text-xs grid grid-cols-2 gap-x-2 mt-1 text-gray-400">
                    {% for stat_name, value in ai_pilot.speed_stats.items() %}
                    <span>{{ stat_name }}: {{ value }}</span>
                    {% endfor %}
                </div>
            {% else %}
                <h5 class="font-bold text-lg text-gray-500">无驾驶员</h5>
            {% endif %}
        </div>

        <!-- [新规则：宕机显示] -->
        {% if ai_mech and ai_mech.stance == 'downed' %}
        <div class="phase-indicator" style="color: var(--status-destroyed); border-color: var(--status-destroyed); background-color: #4a2121; margin-bottom: 1rem;">
            系统宕机！
        </div>
        {% endif %}
        <!-- [修改结束] -->

        <table><thead><tr><th>槽位</th><th>名称</th><th>状态</th></tr></thead>
            <tbody>
                {% if ai_mech %}
                {% for slot, part in ai_mech.parts.items() %}
                <!-- [MODIFIED] 移除 onclick, 添加 data-* 属性 -->
                <tr style="cursor: pointer;" data-controller="ai" data-part-slot="{{ slot }}">
                    <td>{{ slot }}</td>
                    <td>{{ part.name if part else 'N/A' }}</td>
                    <td class="status-{{ part.status if part else 'destroyed' }}">{{ part.status if part else 'destroyed' }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr><td colspan="3" style="text-align: center;">AI已被击败</td></tr>
                {% endif %}
            </tbody>
        </table>
        <h4>战斗日志</h4>
        <div class="combat-log">{% for entry in combat_log %}<div class="log-entry">{{ entry }}</div>{% else %}<div>暂无战斗记录。</div>{% endfor %}</div>
    </div>

    <!-- [弹窗] -->
    <!-- [MODIFIED] 为取消按钮添加 ID -->
    <div id="part-selector-modal"><h4>选择攻击部位</h4><div id="part-buttons" style="display: flex; flex-direction: column; gap: 1rem;"></div><button class="btn" id="part-selector-cancel-btn" style="margin-top: 1rem; background-color: #c53030;">取消</button></div>

    <div id="effect-selector-modal">
        <h4>选择触发效果</h4>
        <div id="effect-buttons" style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;">
            <!-- 按钮将由 JS 动态生成 -->
        </div>
    </div>

    <div id="game-over-modal">
        <h2 id="game-over-title" style="font-size: 2rem; margin-bottom: 1.5rem; white-space: pre-wrap;"></h2>
        <!-- [v_REFACTOR_FIX] 修复 url_for 命名空间 -->
        <form action="{{ url_for('game.reset_game') }}" method="POST">
            <button class="btn" style="background-color: var(--primary-color);" type="submit">返回机库</button>
        </form>
    </div>

    <div id="range-continue-modal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: var(--hover-bg-color); border: 2px solid var(--primary-color);
            border-radius: 0.5rem; padding: 2rem; z-index: 100; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <h2 style="font-size: 2rem; margin-bottom: 1.5rem; color: var(--status-ok);">目标已摧毁！</h2>
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <!-- [v_REFACTOR_FIX] 修复 url_for 命名空间 -->
            <form action="{{ url_for('game.respawn_ai') }}" method="POST">
                <button class="btn" style="background-color: var(--primary-color);" type="submit">继续</button>
            </form>
            <!-- [v_REFACTOR_FIX] 修复 url_for 命名空间 -->
            <form action="{{ url_for('game.reset_game') }}" method="POST">
                <button class="btn" style="background-color: var(--border-color);" type="submit">返回机库</button>
            </form>
        </div>
    </div>

    <div id="dice-roll-modal-backdrop">
        <div id="dice-roll-modal">
            <h3 id="dice-roll-title">掷骰结算</h3>
            <div class="dice-roll-section">
                <h4 id="dice-roll-attacker-name">攻击方</h4>
                <span>输入:</span>
                <div class="dice-group" id="dice-roll-attacker-input"></div>
                <span>结果:</span>
                <div class="dice-group" id="dice-roll-attacker-result"></div>
            </div>
            <div class="dice-roll-section">
                <h4 id="dice-roll-defender-name">防御方</h4>
                <span>输入:</span>
                <div class="dice-group" id="dice-roll-defender-input"></div>
                <span>结果:</span>
                <div class="dice-group" id="dice-roll-defender-result"></div>
            </div>
            <div class="dice-roll-section" id="dice-roll-secondary-section" style="display:none;">
                 <h4 id="dice-roll-secondary-title">效果结算</h4>
                 <span>输入:</span>
                 <div class="dice-group" id="dice-roll-secondary-input"></div>
                 <span>结果:</span>
                 <div class="dice-group" id="dice-roll-secondary-result"></div>
            </div>

            <!-- [MODIFIED] 移除 onclick, 添加 ID -->
            <div id="dice-roll-buttons-default">
                <button class="btn" id="dice-roll-close" style="width: auto; padding: 0.5rem 1rem; float: right; margin-top: 1rem; background-color: var(--border-color);">关闭</button>
            </div>
            <div id="dice-roll-buttons-reroll" class="reroll-hidden" style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn" id="dice-roll-skip" style="background-color: var(--border-color); flex: 1;">跳过</button>
                <button class="btn" id="dice-roll-confirm" style="background-color: var(--primary-color); flex: 2;">
                    确认重投 (<span id="reroll-link-cost">1</span> 链接值)
                </button>
            </div>
        </div>
    </div>

    <!-- [新增] 部件详情弹窗 -->
    <div id="part-detail-modal-backdrop">
        <!-- 阻止点击内容区域关闭模态框 -->
        <div id="part-detail-modal">
            <button id="part-detail-close-btn">&times;</button>
            <h3 id="part-detail-title">部件详情</h3>

            <!-- 图像区域 -->
            <div id="part-detail-image-container">
                <img id="part-detail-image" src="" alt="部件图像"
                     onerror="this.style.display='none'; document.getElementById('part-detail-stats-container').style.display='block';">
            </div>

            <!-- 属性回退区域 (默认隐藏) -->
            <div id="part-detail-stats-container" style="display:none;">
                <ul id="part-detail-stats-list">
                    <!-- JS 填充 -->
                </ul>
            </div>

            <!-- 动作区域 -->
            <h4 style="margin-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">动作:</h4>
            <div id="part-detail-actions-list">
                <!-- JS 填充 -->
            </div>
        </div>
    </div>

<!-- [MODIFIED] 移除巨型 <script> 块... -->

<!-- [MODIFIED] ...并替换为 "数据岛" 和模块加载器 -->
<script id="game-data" type="application/json">
{
    "allEntities": {{ game.get_all_entities_as_dict() | tojson | safe }},
    "playerID": "{{ player_mech.id if player_mech else '' }}",
    "playerEntity": {% if player_mech %}{{ player_mech.to_dict() | tojson | safe }}{% else %}null{% endif %},
    "aiEntity": {% if ai_mech %}{{ ai_mech.to_dict() | tojson | safe }}{% else %}null{% endif %},
    "isPlayerLocked": {{ 'true' if is_player_locked else 'false' }},
    "gameOver": "{{ game.game_over or '' }}",
    "visualEvents": {{ visual_feedback_events | tojson | safe }},
    "runProjectilePhase": {{ 'true' if run_projectile_phase else 'false' }},
    "gameMode": "{{ game_mode }}",
    "defeatCount": {{ ai_defeat_count }},
    "orientationMap": {{ orientationMap | tojson | safe }},
    "playerLoadout": {{ player_loadout | tojson | safe }},
    "aiOpponentName": {{ ai_opponent_name | tojson | safe }},
    "apiUrls": {
        "runProjectilePhase": "{{ url_for('game.run_projectile_phase') }}",
        "resetGame": "{{ url_for('game.reset_game') }}",
        "respawnAi": "{{ url_for('game.respawn_ai') }}",
        "endTurn": "{{ url_for('game.end_turn') }}",
        "selectTiming": "{{ url_for('api.select_timing') }}",
        "confirmTiming": "{{ url_for('api.confirm_timing') }}",
        "changeStance": "{{ url_for('api.change_stance') }}",
        "confirmStance": "{{ url_for('api.confirm_stance') }}",
        "skipAdjustment": "{{ url_for('api.skip_adjustment') }}",
        "jettisonPart": "{{ url_for('api.jettison_part') }}",
        "resolveEffectChoice": "{{ url_for('api.resolve_effect_choice') }}",
        "resolveReroll": "{{ url_for('api.resolve_reroll') }}",
        "getMoveRange": "{{ url_for('api.get_move_range') }}",
        "getAttackRange": "{{ url_for('api.get_attack_range') }}",
        "executeAdjustMove": "{{ url_for('api.execute_adjust_move') }}",
        "changeOrientation": "{{ url_for('api.change_orientation') }}",
        "movePlayer": "{{ url_for('api.move_player') }}",
        "executeAttack": "{{ url_for('api.execute_attack') }}"
    }
}
</script>

<!-- [NEW] 加载新的 JS 模块 -->
<!-- [v_REFACTOR_FIX] 修复 Flask 的 url_for 语法 -->
<script type="module" src="{{ url_for('static', filename='js/game.js') }}"></script>


<!-- [NEW] 错误弹窗 (用于捕获JS中的fetch错误) -->
<div id="error-modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 299; justify-content: center; align-items: center;">
    <div id="error-modal" style="background-color: var(--hover-bg-color); border: 2px solid var(--status-destroyed); border-radius: 0.5rem; padding: 2rem; z-index: 300; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 500px;">
        <h2 id="error-title" style="font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--status-destroyed);">发生后端错误</h2>
        <p id="error-message" style="color: var(--text-color); margin-bottom: 1.5rem; text-align: left; background-color: var(--bg-color); padding: 1rem; border-radius: 0.25rem; font-family: monospace; max-height: 200px; overflow-y: auto;"></p>
        <button id="error-close-btn" class="btn" style="background-color: var(--primary-color);" onclick="window.location.reload();">关闭并重载</button>
    </div>
</div>


<!-- [MODIFIED] Firebase Analytics 脚本 (保持不变) -->
<script type="module">
    // 导入 Firebase 模块
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // [MODIFIED] 导入更多 firestore 功能
    import { getFirestore, doc, setDoc, increment, writeBatch, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let db, analyticsPath;
    let isAuthReady = false;

    try {
        // --- 1. 初始化 Firebase ---
        // [MODIFIED] 从全局 window 变量读取
        const firebaseConfig = window.firebaseConfig || {};
        const appId = window.__app_id || 'default-app-id';
        const auth_token = window.__initial_auth_token || 'undefined';

        analyticsPath = `/artifacts/${appId}/public/data/analytics`; // [FIX] 确保 analyticsPath 被定义

        // [MODIFIED] 移除旧的 JSON.parse 逻辑
        if (!firebaseConfig.apiKey) {
            throw new Error("Firebase config is empty. Analytics will be disabled.");
        }

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug');

        analyticsPath = `/artifacts/${appId}/public/data/analytics`;

        // --- 2. 认证 ---
        if (auth_token && auth_token !== 'undefined' && auth_token !== 'None') {
            await signInWithCustomToken(auth, auth_token);
        } else {
            await signInAnonymously(auth);
        }
        isAuthReady = true;
        console.log("Firebase (Analytics) 已准备就绪。");

    } catch (error) {
        console.error("Firebase (Analytics) 初始化失败:", error);
    }

    // --- 3. 定义分析函数并附加到 window ---
    // [MODIFIED] 扩展函数以接受新数据
    window.recordGameOutcome = async (status, playerLoadout, aiName) => {
        if (!isAuthReady || !db) {
            console.warn("Firebase 尚未准备好，跳过游戏结果分析。");
            return;
        }

        let generalOutcomeKey = null; // 用于 game_outcomes (player_wins / ai_wins)
        let specificOutcomeKey = null; // 用于 ai_matchups (player_wins / player_losses)

        if (status === 'player_win') {
            generalOutcomeKey = 'player_wins';
            specificOutcomeKey = 'player_wins';
        } else if (status === 'ai_win') {
            generalOutcomeKey = 'ai_wins';
            specificOutcomeKey = 'player_losses';
        } else {
            // 不记录 'ai_defeated_in_range' 或其他状态
            return;
        }

        try {
            // 使用批量写入来合并所有数据库操作
            const batch = writeBatch(db);

            // 1. 记录全局胜/负
            const outcomesDocRef = doc(db, analyticsPath, "game_outcomes");
            batch.set(outcomesDocRef, {
                [generalOutcomeKey]: increment(1)
            }, { merge: true });

            // 2. 记录针对特定AI的胜/负
            // 清理AI名称，使其可以用作 Firestore 文档的键 (替换掉非法字符)
            const aiNameKey = aiName.replace(/[.\#[\]$]/g, '_');
            const aiMatchupRef = doc(db, analyticsPath, "ai_matchups");
            // 使用点符号来更新嵌套对象
            batch.set(aiMatchupRef, {
                [aiNameKey]: {
                    [specificOutcomeKey]: increment(1)
                }
            }, { merge: true });

            // 3. 记录胜利时的部件配置 (仅当玩家胜利时)
            if (status === 'player_win' && playerLoadout) {

                // [FIX] 'winning_loadouts' 是一个顶层集合, 与 'analytics' 平行
                // 1. 创建正确的路径 (5 段)
                const winningLoadoutsCollectionPath = analyticsPath.replace("analytics", "winning_loadouts");
                // 2. 引用该集合
                const winningLoadoutsRef = collection(db, winningLoadoutsCollectionPath);

                // 创建一个指向 'winning_loadouts' 集合中新文档的引用
                // [FIX] 使用修正后的 winningLoadoutsRef
                const winningLoadoutRef = doc(winningLoadoutsRef);

                // 添加一个时间戳
                const loadoutData = {
                    ...playerLoadout,
                    timestamp: serverTimestamp()
                };
                batch.set(winningLoadoutRef, loadoutData);
            }

            // 提交所有更改
            await batch.commit();
            console.log(`分析数据已记录: ${generalOutcomeKey}, ${aiNameKey}.${specificOutcomeKey}`);

        } catch (error) {
            console.error("记录游戏结果失败:", error);
        }
    };
</script>

</body>
</html>