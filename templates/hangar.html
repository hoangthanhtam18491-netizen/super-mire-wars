<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机库 - 机甲整备</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- [NEW] Firebase SDK (必须在 <head> 中) -->
    <script type="module">
        // [MODIFIED] firebase_config 现在是一个字典, tojson 会正确地将其序列化为 JSON 对象字面量
        const firebaseConfig = {{ firebase_config | tojson | safe }};

        try {
            if (firebaseConfig.apiKey) {
                // 只有在配置有效时才加载 SDK
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                initializeApp(firebaseConfig);
            } else {
                console.warn("Firebase config is empty. Analytics will be disabled.");
            }
        } catch (e) {
            console.error("Firebase initialization error:", e);
        }
    </script>
    <style>
        .part-card { transition: all 0.2s ease-in-out; }
        .part-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

        /* 默认选中样式 (蓝色) */
        input[type="radio"]:checked + label:not(.raven-card) { border-color: #3b82f6; background-color: #2563eb20; }

        /* [NEW] Raven 专属红黑配色 */
        .raven-card {
            background-color: #0f0f0f !important; /* 接近纯黑 */
            border-color: #742a2a !important; /* 暗红边框 */
            color: #fc8181; /* 红色文字 */
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
        }
        .raven-card:hover {
            border-color: #e53e3e !important; /* 悬停变亮红 */
            box-shadow: 0 0 15px rgba(229, 62, 62, 0.4);
        }
        /* Raven 选中样式 */
        input[type="radio"]:checked + label.raven-card {
            border-color: #f56565 !important; /* 亮红 */
            background-color: rgba(155, 44, 44, 0.4) !important; /* 半透明红背景 */
            box-shadow: 0 0 20px rgba(245, 101, 101, 0.6);
            animation: raven-pulse 2s infinite;
        }
        @keyframes raven-pulse {
            0% { box-shadow: 0 0 10px rgba(245, 101, 101, 0.4); }
            50% { box-shadow: 0 0 25px rgba(245, 101, 101, 0.7); border-color: #fc8181; }
            100% { box-shadow: 0 0 10px rgba(245, 101, 101, 0.4); }
        }


        /* 示意图和总览样式 */
        .overview-box {
            height: 100%;
            min-height: 4rem;
            background-color: #374151;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
            color: #9ca3af;
            overflow: hidden;
            position: relative;
        }
        .overview-box.active {
            border-color: #3b82f6;
            background-color: #4b5563;
            color: #e5e7eb;
            font-weight: 600;
        }
        .overview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .overview-box span {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 0.5rem;
            box-sizing: border-box;
        }

        /* 图像卡片样式 */
        .part-card-image {
            position: relative;
            overflow: hidden;
            height: 20rem;
        }
        .part-card-image img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .part-card-image .part-info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(0deg, rgba(31, 41, 55, 1) 0%, rgba(31, 41, 55, 0.95) 50%, rgba(31, 41, 55, 0) 100%);
            padding: 2.5rem 1rem 1rem 1rem;
            transition: all 0.2s ease-in-out;
        }
        .part-card-image .part-actions {
             font-size: 0.75rem;
             line-height: 1.5;
        }

        .part-card-text {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 20rem;
        }
        .part-card-text .part-info-text {
            flex-grow: 1;
        }

        /* [NEW] 乌鸦触发器样式 */
        #raven-trigger {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 48px;
            height: 48px;
            opacity: 0.1; /* 极高透明度 */
            cursor: pointer;
            z-index: 50;
            transition: opacity 0.5s ease;
        }
        #raven-trigger:hover {
            opacity: 0.3;
        }
        #raven-trigger.activated {
            opacity: 1 !important;
            filter: drop-shadow(0 0 10px red);
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 font-mono relative">

    <!-- [NEW] 隐藏的乌鸦触发器 -->
    <!-- 使用占位符图片，你可以替换为你自己的 '乌鸦剪影' URL -->
    <img id="raven-trigger" src="static/images/badge/Raven.png" alt="Mystery Signal">

    <div class="container mx-auto p-8">
        <h1 class="text-4xl font-bold text-center mb-2 text-blue-400">机库整备</h1>
        <p class="text-center text-gray-400 mb-8">为你的机甲选择装备，然后进入战场。</p>

        <form id="hangar-form" action="{{ url_for('main.start_game') }}" method="POST">

            <!-- 机甲总览与示意图 -->
            <div class="mb-10 p-4 md:p-6 bg-gray-900 rounded-lg shadow-inner grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-gray-800 p-4 rounded-lg flex justify-center items-center">
                    <div class="grid grid-cols-5 gap-2 w-full max-w-2xl text-center text-sm">
                        <div id="overview-core" class="overview-box col-span-1 min-h-[8rem] cursor-pointer" onclick="showPartCategory('core')"><span>核心</span></div>
                        <div id="overview-legs" class="overview-box col-span-1 min-h-[8rem] cursor-pointer" onclick="showPartCategory('legs')"><span>下肢</span></div>
                        <div id="overview-left_arm" class="overview-box col-span-1 min-h-[8rem] cursor-pointer" onclick="showPartCategory('left_arm')"><span>左臂</span></div>
                        <div id="overview-right_arm" class="overview-box col-span-1 min-h-[8rem] cursor-pointer" onclick="showPartCategory('right_arm')"><span>右臂</span></div>
                        <div id="overview-backpack" class="overview-box col-span-1 min-h-[8rem] cursor-pointer" onclick="showPartCategory('backpack')"><span>背包</span></div>
                    </div>
                </div>
                <div class="md:col-span-1">
                    <h3 class="text-2xl font-bold mb-4 text-blue-300">机甲总览</h3>
                    <div class="space-y-4">
                        <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                            <div class="text-gray-400">总闪避</div>
                            <div id="total-evasion" class="text-3xl font-bold text-blue-400">0</div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                            <div class="text-gray-400">总电子</div>
                            <div id="total-electronics" class="text-3xl font-bold text-blue-400">0</div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                            <div class="text-gray-400">调整移动</div>
                            <div id="total-adjust-move" class="text-3xl font-bold text-blue-400">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 机甲部件选择 -->
            <h2 class="text-3xl font-bold mb-6 text-center text-blue-300">1. 选择你的机甲部件</h2>
            <div class="part-selection-container mt-6">

                <!-- 核心 -->
                <div class="part-selection-column" data-part-type="core" style="display: none;">
                    <h3 class="text-2xl font-semibold mb-4 text-center border-b-2 border-blue-500 pb-2">核心</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                    {% for name, part in cores.items() %}
                    <div class="mb-4 w-56">
                        <input type="radio" id="core_{{ name }}" name="core" value="{{ name }}" class="hidden" required {% if loop.first %}checked{% endif %}
                               data-part-type="core" data-evasion="{{ part.evasion|default(0) }}" data-electronics="{{ part.electronics|default(0) }}" data-adjust-move="0" data-image-url="{{ part.image_url|default('') }}">
                        <label for="core_{{ name }}" class="part-card block bg-gray-700 rounded-lg border-2 border-gray-600 cursor-pointer h-full">
                            {% if part.image_url %}
                            <div class="part-card-image">
                                <img src="{{ part.image_url }}" alt="{{ name }}" onerror="this.onerror=null; this.src='https://placehold.co/256x384/374151/E5E7EB?text=IMAGE+NOT+FOUND';">
                                <div class="part-info-overlay">
                                    <h4 class="font-bold text-lg text-blue-300 truncate">{{ name }}</h4>
                                    <p class="text-sm">装甲: {{ part.armor }}, 结构: {{ part.structure }}</p>
                                    <p class="text-sm">闪避: {{ part.evasion }}, 电子: {{ part.electronics }}</p>
                                    <div class="part-actions mt-2">
                                        <p class="text-sm font-semibold">动作:</p>
                                        {% if part.actions %}
                                            {% for action in part.actions %}
                                                <span class="block text-blue-300">&ndash; {{ action.name }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="block">无</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="part-card-text p-4">
                                <div class="part-info-text">
                                    <h4 class="font-bold text-lg text-blue-300">{{ name }}</h4>
                                    <p class="text-sm">装甲: {{ part.armor }}, 结构: {{ part.structure }}</p>
                                    <p class="text-sm">闪避: {{ part.evasion }}, 电子: {{ part.electronics }}</p>
                                </div>
                                <p class="text-sm mt-1 font-semibold">动作:</p>
                                {% if part.actions %}
                                    {% for action in part.actions %}
                                        <span class="block text-xs text-blue-300">&ndash; {{ action.name }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="block text-xs">无</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>

                <!-- 下肢 -->
                <div class="part-selection-column" data-part-type="legs" style="display: none;">
                    <h3 class="text-2xl font-semibold mb-4 text-center border-b-2 border-blue-500 pb-2">下肢</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                    {% for name, part in legs.items() %}
                    <div class="mb-4 w-56">
                        <input type="radio" id="legs_{{ name }}" name="legs" value="{{ name }}" class="hidden" required {% if loop.first %}checked{% endif %}
                               data-part-type="legs" data-evasion="{{ part.evasion|default(0) }}" data-electronics="{{ part.electronics|default(0) }}" data-adjust-move="{{ part.adjust_move|default(0) }}" data-image-url="{{ part.image_url|default('') }}">
                        <label for="legs_{{ name }}" class="part-card block bg-gray-700 rounded-lg border-2 border-gray-600 cursor-pointer h-full">
                            {% if part.image_url %}
                            <div class="part-card-image">
                                <img src="{{ part.image_url }}" alt="{{ name }}" onerror="this.onerror=null; this.src='https://placehold.co/256x384/374151/E5E7EB?text=IMAGE+NOT+FOUND';">
                                <div class="part-info-overlay">
                                    <h4 class="font-bold text-lg text-blue-300 truncate">{{ name }}</h4>
                                    <p class="text-sm">装甲: {{ part.armor }}, 移动: {{ part.adjust_move }}</p>
                                    <div class="part-actions mt-2">
                                        {% if part.actions %}{% for action in part.actions %}<span class="block text-blue-300">&ndash; {{ action.name }}</span>{% endfor %}{% endif %}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="part-card-text p-4">
                                <div class="part-info-text"><h4 class="font-bold text-lg text-blue-300">{{ name }}</h4><p class="text-sm">移动: {{ part.adjust_move }}</p></div>
                                <p class="text-sm mt-1 font-semibold">动作:</p>
                                {% if part.actions %}
                                    {% for action in part.actions %}
                                        <span class="block text-xs text-blue-300">&ndash; {{ action.name }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>

                <!-- 左臂 -->
                <div class="part-selection-column" data-part-type="left_arm" style="display: none;">
                    <h3 class="text-2xl font-semibold mb-4 text-center border-b-2 border-blue-500 pb-2">左臂</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                    {% for name, part in left_arms.items() %}
                    <div class="mb-4 w-56">
                        <input type="radio" id="left_arm_{{ name }}" name="left_arm" value="{{ name }}" class="hidden" required {% if loop.first %}checked{% endif %}
                               data-part-type="left_arm" data-evasion="{{ part.evasion|default(0) }}" data-electronics="{{ part.electronics|default(0) }}" data-adjust-move="0" data-image-url="{{ part.image_url|default('') }}">
                        <label for="left_arm_{{ name }}" class="part-card block bg-gray-700 rounded-lg border-2 border-gray-600 cursor-pointer h-full">
                            {% if part.image_url %}
                            <div class="part-card-image">
                                <img src="{{ part.image_url }}" alt="{{ name }}" onerror="this.onerror=null; this.src='https://placehold.co/256x384/374151/E5E7EB?text=IMAGE+NOT+FOUND';">
                                <div class="part-info-overlay">
                                    <h4 class="font-bold text-lg text-blue-300 truncate">{{ name }}</h4>
                                    <div class="part-actions mt-2">
                                        {% if part.actions %}{% for action in part.actions %}<span class="block text-blue-300">&ndash; {{ action.name }}</span>{% endfor %}{% endif %}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="part-card-text p-4"><div class="part-info-text"><h4 class="font-bold text-lg text-blue-300">{{ name }}</h4></div>
                                <p class="text-sm mt-1 font-semibold">动作:</p>
                                {% if part.actions %}
                                    {% for action in part.actions %}
                                        <span class="block text-xs text-blue-300">&ndash; {{ action.name }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>

                <!-- 右臂 -->
                <div class="part-selection-column" data-part-type="right_arm" style="display: none;">
                    <h3 class="text-2xl font-semibold mb-4 text-center border-b-2 border-blue-500 pb-2">右臂</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                    {% for name, part in right_arms.items() %}
                    <div class="mb-4 w-56">
                        <input type="radio" id="right_arm_{{ name }}" name="right_arm" value="{{ name }}" class="hidden" required {% if loop.first %}checked{% endif %}
                               data-part-type="right_arm" data-evasion="{{ part.evasion|default(0) }}" data-electronics="{{ part.electronics|default(0) }}" data-adjust-move="0" data-image-url="{{ part.image_url|default('') }}">
                        <label for="right_arm_{{ name }}" class="part-card block bg-gray-700 rounded-lg border-2 border-gray-600 cursor-pointer h-full">
                            {% if part.image_url %}
                            <div class="part-card-image">
                                <img src="{{ part.image_url }}" alt="{{ name }}" onerror="this.onerror=null; this.src='https://placehold.co/256x384/374151/E5E7EB?text=IMAGE+NOT+FOUND';">
                                <div class="part-info-overlay">
                                    <h4 class="font-bold text-lg text-blue-300 truncate">{{ name }}</h4>
                                    <div class="part-actions mt-2">
                                        {% if part.actions %}{% for action in part.actions %}<span class="block text-blue-300">&ndash; {{ action.name }}</span>{% endfor %}{% endif %}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="part-card-text p-4"><div class="part-info-text"><h4 class="font-bold text-lg text-blue-300">{{ name }}</h4></div>
                                <p class="text-sm mt-1 font-semibold">动作:</p>
                                {% if part.actions %}
                                    {% for action in part.actions %}
                                        <span class="block text-xs text-blue-300">&ndash; {{ action.name }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>

                <!-- 背包 -->
                <div class="part-selection-column" data-part-type="backpack" style="display: none;">
                    <h3 class="text-2xl font-semibold mb-4 text-center border-b-2 border-blue-500 pb-2">背包</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                    {% for name, part in backpacks.items() %}
                    <div class="mb-4 w-56">
                        <input type="radio" id="backpack_{{ name }}" name="backpack" value="{{ name }}" class="hidden" required {% if loop.first %}checked{% endif %}
                               data-part-type="backpack" data-evasion="{{ part.evasion|default(0) }}" data-electronics="{{ part.electronics|default(0) }}" data-adjust-move="0" data-image-url="{{ part.image_url|default('') }}">
                        <label for="backpack_{{ name }}" class="part-card block bg-gray-700 rounded-lg border-2 border-gray-600 cursor-pointer h-full">
                            {% if part.image_url %}
                            <div class="part-card-image">
                                <img src="{{ part.image_url }}" alt="{{ name }}" onerror="this.onerror=null; this.src='https://placehold.co/256x384/374151/E5E7EB?text=IMAGE+NOT+FOUND';">
                                <div class="part-info-overlay">
                                    <h4 class="font-bold text-lg text-blue-300 truncate">{{ name }}</h4>
                                    <div class="part-actions mt-2">
                                        {% if part.actions %}{% for action in part.actions %}<span class="block text-blue-300">&ndash; {{ action.name }}</span>{% endfor %}{% endif %}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="part-card-text p-4"><div class="part-info-text"><h4 class="font-bold text-lg text-blue-300">{{ name }}</h4></div>
                                <p class="text-sm mt-1 font-semibold">动作:</p>
                                {% if part.actions %}
                                    {% for action in part.actions %}
                                        <span class="block text-xs text-blue-300">&ndash; {{ action.name }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </label>
                    </div>
                    {% endfor %}
                    </div>
                </div>

            </div>


            <!-- 驾驶员选择 -->
            <div class="mt-10">
                <h2 class="text-3xl font-bold mb-6 text-center text-blue-300">2. 选择你的驾驶员</h2>
                <div class="flex justify-center flex-wrap gap-6">
                    {% for name, pilot in player_pilots.items() %}
                    <div class="mb-4">
                        <input type="radio" id="pilot_{{ name }}" name="pilot" value="{{ name }}" class="hidden" required {% if loop.first %}checked{% endif %}>
                        <label for="pilot_{{ name }}" class="part-card block bg-gray-700 p-6 rounded-lg border-2 border-gray-600 cursor-pointer w-72">
                            <h4 class="font-bold text-xl text-blue-300">{{ name }}</h4>
                            <p class="text-sm mt-2">链接值: {{ pilot.link_points }}</p>
                            <div class="text-sm grid grid-cols-2 gap-x-4 mt-2 text-gray-400">
                                {% for stat_name, value in pilot.speed_stats.items() %}
                                <span>{{ stat_name }}: {{ value }}</span>
                                {% endfor %}
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- AI 对手选择 -->
            <div class="mt-10">
                <h2 class="text-3xl font-bold mb-6 text-center text-blue-300">3. 选择初始对手</h2>
                <div class="flex justify-center flex-wrap gap-6">
                    {% for key, loadout in ai_loadouts.items() %}
                    <!-- [MODIFIED] 如果 key 是 'raven'，默认添加 'hidden' 类隐藏它 -->
                    <div class="mb-4 {{ 'hidden' if key == 'raven' else '' }}" id="container_ai_{{ key }}">
                        <input type="radio" id="ai_{{ key }}" name="ai_opponent" value="{{ key }}" class="hidden" required {% if loop.first %}checked{% endif %}>
                        <!-- [MODIFIED] 如果是 Raven, 应用 .raven-card 样式, 否则应用标准样式 -->
                        <label for="ai_{{ key }}" class="part-card block p-6 rounded-lg border-2 cursor-pointer w-72 {{ 'raven-card' if key == 'raven' else 'bg-gray-700 border-gray-600' }}">
                            <!-- [MODIFIED] Raven 文字变红 -->
                            <h4 class="font-bold text-xl {{ 'text-red-500' if key == 'raven' else 'text-blue-300' }}">{{ loadout.name }}</h4>
                            <p class="text-sm mt-2">核心: {{ loadout.selection.core }}</p>
                            <p class="text-sm">武器: {{ loadout.selection.left_arm }}, {{ loadout.selection.right_arm }}</p>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- 游戏模式选择 -->
            <div class="mt-10">
                <h2 class="text-3xl font-bold mb-6 text-center text-blue-300">4. 选择游戏模式</h2>
                <div class="flex justify-center flex-wrap gap-6">
                    <div class="mb-4">
                        <input type="radio" id="mode_duel" name="game_mode" value="duel" class="hidden" required checked>
                        <label for="mode_duel" class="part-card block bg-gray-700 p-6 rounded-lg border-2 border-gray-600 cursor-pointer w-72">
                            <h4 class="font-bold text-xl text-blue-300">决斗模式 (1v1)</h4>
                            <p class="text-sm mt-2">正面对决。</p>
                        </label>
                    </div>
                    <div class="mb-4">
                        <input type="radio" id="mode_horde" name="game_mode" value="horde" class="hidden" required>
                        <label for="mode_horde" class="part-card block bg-gray-700 p-6 rounded-lg border-2 border-gray-600 cursor-pointer w-72">
                            <h4 class="font-bold text-xl text-blue-300">生存模式 (Horde)</h4>
                            <p class="text-sm mt-2">迎战从底部不断刷新的敌人。</p>
                        </label>
                    </div>
                     <div class="mb-4">
                         <input type="radio" id="mode_range" name="game_mode" value="range" class="hidden" required>
                         <label for="mode_range" class="part-card block bg-gray-700 p-6 rounded-lg border-2 border-gray-600 cursor-pointer w-72">
                             <h4 class="font-bold text-xl text-blue-300">靶场模式</h4>
                             <p class="text-sm mt-2">AI不会行动。被击败后可重置。</p>
                         </label>
                     </div>
                </div>
            </div>

            <!-- 开始按钮 -->
            <div class="mt-10 text-center">
                <button type="button" id="start-game-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-lg text-2xl transition-all duration-300 shadow-lg hover:shadow-xl">
                    开始战斗
                </button>
            </div>
        </form>
    </div>

    <!-- [MODIFIED] 脚本逻辑 -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... 原有的部件统计和切换逻辑保持不变 ...
            const allRadioInputs = document.querySelectorAll('input[type="radio"]');
            const defaultTexts = { core: '核心', legs: '下肢', left_arm: '左臂', right_arm: '右臂', backpack: '背包' };
            function updateOverview() {
                let totalEvasion = 0; let totalElectronics = 0; let totalAdjustMove = 0;
                document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                    totalEvasion += parseFloat(input.dataset.evasion || 0);
                    totalElectronics += parseFloat(input.dataset.electronics || 0);
                    totalAdjustMove += parseFloat(input.dataset.adjustMove || 0);
                    const partType = input.dataset.partType;
                    if (partType) {
                         const partName = input.value; const imageUrl = input.dataset.imageUrl; const overviewBox = document.getElementById(`overview-${partType}`);
                         if(overviewBox) overviewBox.innerHTML = imageUrl ? `<img src="${imageUrl}" onerror="this.parentNode.innerHTML='<span>${partName.split(' ')[0]}</span>'">` : `<span>${partName.split(' ')[0]}</span>`;
                    }
                });
                document.getElementById('total-evasion').innerText = totalEvasion;
                document.getElementById('total-electronics').innerText = totalElectronics;
                document.getElementById('total-adjust-move').innerText = totalAdjustMove;
            }
            window.showPartCategory = function(partTypeToShow) {
                document.querySelectorAll('.part-selection-column').forEach(col => col.style.display = 'none');
                const columnToShow = document.querySelector(`.part-selection-column[data-part-type="${partTypeToShow}"]`);
                if (columnToShow) columnToShow.style.display = 'block';
                document.querySelectorAll('.overview-box').forEach(box => box.classList.remove('active'));
                const activeBox = document.getElementById(`overview-${partTypeToShow}`);
                if (activeBox) activeBox.classList.add('active');
            }
            allRadioInputs.forEach(input => input.addEventListener('change', updateOverview));
            updateOverview();
            showPartCategory('core');

            // === [NEW] Raven 触发器逻辑 ===
            const ravenTrigger = document.getElementById('raven-trigger');
            let ravenClickCount = 0;

            if (ravenTrigger) {
                ravenTrigger.addEventListener('click', () => {
                    ravenClickCount++;
                    console.log("Signal detected:", ravenClickCount);

                    if (ravenClickCount >= 3) {
                        // 1. 选中隐藏的 Raven 选项
                        const ravenRadio = document.getElementById('ai_raven');
                        const ravenContainer = document.getElementById('container_ai_raven');
                        if (ravenRadio && ravenContainer) {
                            ravenContainer.classList.remove('hidden'); // 显示卡片
                            ravenRadio.checked = true;
                            console.log("Target locked: RAVEN");

                            // 2. 视觉反馈
                            ravenTrigger.classList.add('activated');

                            // 3. 自动切换到决斗模式 (可选，但符合逻辑)
                            const duelMode = document.getElementById('mode_duel');
                            if(duelMode) duelMode.checked = true;

                            // 4. 更新统计数据 (因为改变了选项)
                            updateOverview();
                        }
                    }
                });
            }
        });
    </script>

    <!-- [NEW] Firebase Analytics 脚本 (带超时保护) -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, analyticsPath, batch;
        let isFirebaseInitialized = false;

        const firebaseConfig = {{ firebase_config | tojson | safe }};
        const __app_id = {{ app_id | tojson | safe }};
        const __initial_auth_token = {{ initial_auth_token | tojson | safe }};

        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : 'undefined';
            analyticsPath = `/artifacts/${appId}/public/data/analytics`;

            if (!firebaseConfig.apiKey) {
                throw new Error("Firebase config is empty. Analytics will be disabled.");
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            setLogLevel('Debug');

            const auth = getAuth(app);
            if (auth_token && auth_token !== 'undefined') {
                await signInWithCustomToken(auth, auth_token);
            } else {
                await signInAnonymously(auth);
            }
            console.log("Firebase Auth success. User:", auth.currentUser.uid);
            isFirebaseInitialized = true;
        } catch (e) {
            console.error("Firebase Hangar Analytics Error:", e);
        }

        // --- 3. 绑定表单提交事件 ---
        const form = document.getElementById('hangar-form');
        const submitButton = document.getElementById('start-game-btn');

        submitButton.onclick = async (e) => {
            e.preventDefault(); // 阻止表单立即提交

            // 禁用按钮防止重复点击
            submitButton.disabled = true;
            submitButton.innerText = "加载中...";

            if (isFirebaseInitialized) {
                try {
                    // --- 4. 准备批量写入 ---
                    const batch = writeBatch(db);

                    // A. 统计部件选择
                    const partSelectionsRef = doc(db, analyticsPath, "part_selections");
                    const partData = {};
                    partData[`parts.${document.querySelector('input[name="core"]:checked').value}`] = increment(1);
                    partData[`parts.${document.querySelector('input[name="legs"]:checked').value}`] = increment(1);
                    partData[`parts.${document.querySelector('input[name="left_arm"]:checked').value}`] = increment(1);
                    partData[`parts.${document.querySelector('input[name="right_arm"]:checked').value}`] = increment(1);
                    partData[`parts.${document.querySelector('input[name="backpack"]:checked').value}`] = increment(1);
                    batch.set(partSelectionsRef, partData, { merge: true });

                    // B. 统计AI选择
                    const aiSelectionsRef = doc(db, analyticsPath, "ai_selections");
                    const aiInput = document.querySelector('input[name="ai_opponent"]:checked');
                    const aiKey = aiInput.value;
                    const aiLabel = document.querySelector(`label[for="ai_${aiKey}"] h4`);
                    const aiName = aiLabel ? aiLabel.innerText : aiKey;
                    batch.set(aiSelectionsRef, { [aiName]: increment(1) }, { merge: true });

                    // C. 统计模式选择
                    const modeSelectionsRef = doc(db, analyticsPath, "mode_selections");
                    const modeKey = document.querySelector('input[name="game_mode"]:checked').value;
                    const modeName = document.querySelector(`label[for="mode_${modeKey}"] h4`).innerText;
                    batch.set(modeSelectionsRef, { [modeName]: increment(1) }, { merge: true });

                    // --- 5. 提交数据 (带超时保护) ---
                    console.log("Sending analytics batch...");

                    // 创建一个超时 Promise (2秒)
                    const timeout = new Promise((resolve) => setTimeout(() => resolve('timeout'), 2000));

                    // 竞态：Firebase 提交 vs 超时
                    const result = await Promise.race([batch.commit(), timeout]);

                    if (result === 'timeout') {
                        console.warn("Analytics submission timed out. Proceeding...");
                    } else {
                        console.log("Analytics batch sent!");
                    }

                } catch (e) {
                    console.error("Error sending analytics:", e);
                    // 即使分析失败，也要继续游戏
                }
            } else {
                console.warn("Firebase 未初始化, 跳过分析。");
            }

            // --- 6. 提交表单 ---
            form.submit();
        };

    </script>
</body>
</html>