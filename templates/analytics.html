<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏数据统计</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* [新增] 错误信息样式 */
        .error-message {
            color: #f56565; /* text-red-400 */
            font-size: 0.875rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 font-mono">

    <!-- 加载指示器 -->
    <div id="loading-indicator" class="flex items-center justify-center h-screen">
        <div class="flex flex-col items-center">
            <div class="spinner w-12 h-12 rounded-full border-4 border-t-blue-500 border-gray-600 mb-4"></div>
            <p id="loading-text" class="text-lg text-gray-400">正在加载统计数据...</p>
            <!-- [FIX #7] 详细错误信息将显示在这里 -->
            <p id="loading-error-details" class="text-sm text-red-400 mt-2 max-w-md text-center"></p>
        </div>
    </div>

    <!-- 统计数据网格 (默认隐藏) -->
    <div id="analytics-grid" class="hidden container mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- 概览 -->
        <div class="lg:col-span-3 bg-gray-900 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-blue-400 border-b border-gray-700 pb-2">数据概览</h2>
            <div id="game-outcomes-data" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <p class="text-gray-500">加载中...</p>
            </div>
        </div>

        <!-- AI 对战胜率 -->
        <div class="bg-gray-900 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4 text-blue-400 border-b border-gray-700 pb-2">AI 对战胜率</h2>
            <div id="ai-matchups-data" class="space-y-4 max-h-96 overflow-y-auto">
                <p class="text-gray-500">加载中...</p>
            </div>
        </div>

        <!-- 部件选择 -->
        <div class="bg-gray-900 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4 text-blue-400 border-b border-gray-700 pb-2">部件选择次数</h2>
            <div id="part-selections-data" class="space-y-2 max-h-96 overflow-y-auto">
                <p class="text-gray-500">加载中...</p>
            </div>
        </div>

        <!-- 模式与AI选择 -->
        <div class="bg-gray-900 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4 text-blue-400 border-b border-gray-700 pb-2">模式与AI选择</h2>
            <h3 class="text-lg font-semibold text-gray-300 mt-4">AI 对手</h3>
            <div id="ai-selections-data" class="space-y-2 mb-4 max-h-48 overflow-y-auto">
                <p class="text-gray-500">加载中...</p>
            </div>
            <h3 class="text-lg font-semibold text-gray-300 mt-4">游戏模式</h3>
            <div id="mode-selections-data" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-gray-500">加载中...</p>
            </div>
        </div>

        <!-- 最近的胜利配置 -->
        <div class="lg:col-span-3 bg-gray-900 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-blue-400 border-b border-gray-700 pb-2">最近的胜利配置 (最新 20 场)</h2>
            <div id="winning-loadouts-data" class="space-y-4 max-h-96 overflow-y-auto">
                <p class="text-gray-500">加载中...</p>
            </div>
        </div>

    </div>

    <!-- Firebase 脚本 -->
    <script type="module">
        // [MODIFIED] 导入语句保持在顶层
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // [MODIFIED] 将所有逻辑封装在一个 async main 函数中
        async function main() {
            // [MODIFIED] 在函数开始时获取所有 DOM 元素
            const loadingIndicator = document.getElementById('loading-indicator');
            const analyticsGrid = document.getElementById('analytics-grid');
            const loadingText = document.getElementById('loading-text');
            const errorDetails = document.getElementById('loading-error-details');

            const firebaseConfig = {{ firebase_config | tojson | safe }};
            const __app_id = {{ app_id | tojson | safe }};
            const __initial_auth_token = {{ initial_auth_token | tojson | safe }};

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : 'undefined';
            const analyticsPath = `/artifacts/${appId}/public/data/analytics`;

            let db;
            let auth; // [NEW] 将 auth 提升到 main 函数作用域

            // --- [MODIFIED] 步骤 1: 尝试同步初始化 ---
            try {
                setLogLevel('Debug');

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Firebase config is empty or invalid. Analytics will be disabled.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); // [NEW] 初始化 auth

            } catch (e) {
                // [MODIFIED] 如果同步初始化失败 (例如配置错误)，立即显示错误并退出
                console.error("Firebase Initialization Error:", e);
                loadingText.innerText = "无法加载统计数据。";
                loadingText.style.color = "#f56565"; // text-red-400
                let simpleError = e.message.split(' (')[0];
                errorDetails.innerText = `错误详情: ${simpleError}`;
                loadingIndicator.querySelector('.spinner').style.display = 'none';
                return; // 退出 main 函数
            }

            // --- [MODIFIED] 步骤 2: 初始化成功，立即更新 UI ---
            // (Auth 尚未完成, 但我们可以先显示网格)
            loadingIndicator.style.display = 'none';
            analyticsGrid.style.display = 'grid';

            // --- 渲染函数 (保持不变) ---
            const renderError = (containerId, error) => {
                const container = document.getElementById(containerId);
                if (container) {
                    let errorMsg = error.message.split('(')[0].trim();
                    if (errorMsg.includes("Missing or insufficient permissions")) {
                        errorMsg = "加载失败: 权限不足 (请检查 Firebase 安全规则)";
                    } else {
                        errorMsg = `加载失败: ${errorMsg}`;
                    }
                    container.innerHTML = `<p class="error-message">${errorMsg}</p>`;
                }
                console.error(`Firebase Error (${containerId}):`, error);
            };
            const sortAndRender = (data, containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return;
                if (!data || Object.keys(data).length === 0) {
                    container.innerHTML = '<p class="text-gray-500">暂无数据</p>'; return;
                }
                const entries = Object.entries(data);
                entries.sort((a, b) => b[1] - a[1]);
                container.innerHTML = entries.map(([key, value]) => `
                    <div class="flex justify-between items-center text-sm py-1 border-b border-gray-700 last:border-b-0">
                        <span class="truncate pr-2">${key}</span>
                        <span class="font-bold text-blue-300">${value}</span>
                    </div>`).join('');
            };
            const renderAiMatchups = (data) => {
                const container = document.getElementById('ai-matchups-data');
                if (!container) return;
                if (!data || Object.keys(data).length === 0) {
                    container.innerHTML = '<p class="text-gray-500">暂无数据</p>'; return;
                }
                const entries = Object.entries(data);
                entries.sort((a, b) => (b[1].player_wins || 0) - (a[1].player_wins || 0));
                container.innerHTML = entries.map(([aiName, stats]) => {
                    const wins = stats.player_wins || 0; const losses = stats.player_losses || 0; const total = wins + losses;
                    const winRate = total > 0 ? ((wins / total) * 100).toFixed(0) : 0;
                    let winRateColor = 'text-gray-400';
                    if (winRate > 60) winRateColor = 'text-green-400'; else if (winRate < 40) winRateColor = 'text-red-400';
                    return `
                        <div class="mb-2 pb-2 border-b border-gray-700 last:border-b-0">
                            <div class="flex justify-between font-semibold">
                                <span class="truncate pr-2">${aiName}</span>
                                <span class="${winRateColor}">${winRate}% 胜率</span>
                            </div>
                            <div class="text-sm text-gray-400">
                                (胜: <span class="text-green-500">${wins}</span> / 负: <span class="text-red-500">${losses}</span> / 总: ${total})
                            </div>
                        </div>`;
                }).join('') || '<p class="text-gray-500">暂无数据</p>';
            };
            const renderWinningLoadouts = (docs) => {
                const container = document.getElementById('winning-loadouts-data');
                if (!container) return;
                if (!docs || docs.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">暂无胜利记录</p>'; return;
                }
                container.innerHTML = docs.map(doc => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString('zh-CN') : '未知时间';
                    return `
                        <div class="p-3 bg-gray-800 rounded grid grid-cols-2 md:grid-cols-6 gap-2 text-xs border border-gray-700">
                            <div class="md:col-span-1 text-gray-400">${timestamp}</div>
                            <div class="truncate"><span class="text-blue-400">核心:</span> ${data.core || 'N/A'}</div>
                            <div class="truncate"><span class="text-blue-400">下肢:</span> ${data.legs || 'N/A'}</div>
                            <div class="truncate"><span class="text-blue-400">左臂:</span> ${data.left_arm || 'N/A'}</div>
                            <div class="truncate"><span class="text-blue-400">右臂:</span> ${data.right_arm || 'N/A'}</div>
                            <div class="truncate"><span class="text-blue-400">背包:</span> ${data.backpack || 'N/A'}</div>
                        </div>`;
                }).join('');
            };

            // --- [MODIFIED] 步骤 3: 在后台尝试认证 ---
            try {
                if (auth_token && auth_token !== 'undefined' && auth_token !== 'None') {
                    await signInWithCustomToken(auth, auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase Auth success. User:", auth.currentUser.uid);

                // --- [MODIFIED] 步骤 4: 认证成功后，附加监听器 ---
                const partSelectionsRef = doc(db, analyticsPath, "part_selections");
                const aiSelectionsRef = doc(db, analyticsPath, "ai_selections");
                const modeSelectionsRef = doc(db, analyticsPath, "mode_selections");
                const gameOutcomesRef = doc(db, analyticsPath, "game_outcomes");
                const aiMatchupsRef = doc(db, analyticsPath, "ai_matchups");

                // [FIX] 'winning_loadouts' 是一个顶层集合, 与 'analytics' 平行
                // 1. 创建正确的路径 (5 段)
                const winningLoadoutsCollectionPath = analyticsPath.replace("analytics", "winning_loadouts");
                // 2. 引用该集合
                const winningLoadoutsRef = collection(db, winningLoadoutsCollectionPath);

                onSnapshot(partSelectionsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const flatData = docSnap.data(); const cleanedData = {};
                        for (const key in flatData) { if (key.startsWith("parts.")) { const cleanedKey = key.substring(6); cleanedData[cleanedKey] = flatData[key]; } }
                        sortAndRender(cleanedData, 'part-selections-data');
                    } else { sortAndRender(null, 'part-selections-data'); }
                }, (error) => renderError('part-selections-data', error));

                onSnapshot(aiSelectionsRef, (docSnap) => {
                    if (docSnap.exists()) { sortAndRender(docSnap.data(), 'ai-selections-data'); } else { sortAndRender(null, 'ai-selections-data'); }
                }, (error) => renderError('ai-selections-data', error));

                onSnapshot(modeSelectionsRef, (docSnap) => {
                    if (docSnap.exists()) { sortAndRender(docSnap.data(), 'mode-selections-data'); } else { sortAndRender(null, 'mode-selections-data'); }
                }, (error) => renderError('mode-selections-data', error));

                onSnapshot(gameOutcomesRef, (docSnap) => {
                    const container = document.getElementById('game-outcomes-data');
                    if (docSnap.exists()) {
                        const data = docSnap.data(); const wins = data.player_wins || 0; const losses = data.ai_wins || 0; const total = wins + losses;
                        const winRate = total > 0 ? ((wins / total) * 100).toFixed(1) : 0;
                        container.innerHTML = `
                            <div><div class="text-4xl font-bold text-green-400">${wins}</div><div class="text-sm text-gray-400">玩家胜利</div></div>
                            <div><div class="text-4xl font-bold text-red-400">${losses}</div><div class="text-sm text-gray-400">AI 胜利</div></div>
                            <div><div class="text-4xl font-bold text-blue-400">${total}</div><div class="text-sm text-gray-400">总场次</div></div>
                            <div><div class="text-4xl font-bold text-blue-400">${winRate}%</div><div class="text-sm text-gray-400">玩家胜率</div></div>`;
                    } else { container.innerHTML = '<p class="text-gray-500">暂无数据</p>'; }
                }, (error) => renderError('game-outcomes-data', error));

                onSnapshot(aiMatchupsRef, (docSnap) => {
                    if (docSnap.exists()) { renderAiMatchups(docSnap.data()); } else { renderAiMatchups(null); }
                }, (error) => renderError('ai-matchups-data', error));

                // 监听 6: 胜利配置 (查询)
                // [FIX] 使用修正后的 winningLoadoutsRef
                const q = query(winningLoadoutsRef, orderBy("timestamp", "desc"), limit(20));
                onSnapshot(q, (querySnapshot) => {
                    renderWinningLoadouts(querySnapshot.docs);
                }, (error) => renderError('winning-loadouts-data', error));

            } catch (authError) {
                // [NEW] 如果 *认证* 失败 (例如网络超时或被 Firebase 拒绝)
                console.error("Firebase Auth Error:", authError);
                // 在所有卡片中显示认证错误
                renderError('game-outcomes-data', authError);
                renderError('ai-matchups-data', authError);
                renderError('part-selections-data', authError);
                renderError('ai-selections-data', authError);
                renderError('mode-selections-data', authError);
                renderError('winning-loadouts-data', authError);
            }
        }

        // [MODIFIED] 添加事件监听器来启动 main 函数
        document.addEventListener('DOMContentLoaded', main);

    </script>

</body>
</html>